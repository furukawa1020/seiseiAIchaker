{% extends "base.html" %}

{% block title %}RefSys - ãƒ›ãƒ¼ãƒ {% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ“¥ æ–‡çŒ®ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
    <p>CSL-JSONå½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€JSONãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
    
    <form action="/works/import" method="post" enctype="multipart/form-data" onsubmit="return handleImport(event)">
        <label for="file">ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (CSL-JSON):</label>
        <input type="file" name="file" id="file" accept=".json">
        
        <label for="json_data">ã¾ãŸã¯ã€JSONã‚’ç›´æ¥å…¥åŠ›:</label>
        <textarea name="json_data" id="json_data" placeholder='{"title": "...", "author": [...], "DOI": "..."}'></textarea>
        
        <button type="submit" class="btn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    </form>
    
    <div id="import-result"></div>
</div>

<div class="card">
    <h2>ğŸ“š æœ€è¿‘ã®æ–‡çŒ®</h2>
    {% if works %}
    <table>
        <thead>
            <tr>
                <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                <th>è‘—è€…</th>
                <th>å¹´</th>
                <th>æŸ»èª­</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for work in works %}
            <tr>
                <td><a href="/works/{{ work.id }}">{{ work.title }}</a></td>
                <td>{{ work.authors|join(', ') }}</td>
                <td>{{ work.issued_year or '-' }}</td>
                <td>
                    {% if work.peer_reviewed == 1 %}
                    <span class="badge badge-peer-reviewed">âœ“ æŸ»èª­ã‚ã‚Š</span>
                    {% elif work.peer_reviewed == 0 %}
                    <span class="badge badge-not-peer-reviewed">æŸ»èª­ãªã—</span>
                    {% else %}
                    <span class="badge">ä¸æ˜</span>
                    {% endif %}
                    
                    {% if work.retracted %}
                    <span class="badge badge-retracted">âš  æ’¤å›</span>
                    {% endif %}
                </td>
                <td>
                    <a href="/works/{{ work.id }}" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">è©³ç´°</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="alert alert-info">ã¾ã æ–‡çŒ®ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¸Šè¨˜ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚</p>
    {% endif %}
</div>

<div class="card">
    <h2>ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ</h2>
    <ol>
        <li><strong>æ–‡çŒ®ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</strong>: CSL-JSONå½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šè¨˜ãƒ•ã‚©ãƒ¼ãƒ ã§æŠ•å…¥</li>
        <li><strong>å®Ÿåœ¨æ€§æ¤œè¨¼</strong>: æ–‡çŒ®è©³ç´°ãƒšãƒ¼ã‚¸ã§ã€Œæ¤œè¨¼å®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
        <li><strong>PDFèª­äº†è¨˜éŒ²</strong>: PDFã‚’èª­ã¿ãªãŒã‚‰ãƒšãƒ¼ã‚¸æ»åœ¨ã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è¨˜éŒ²</li>
        <li><strong>å¼•ç”¨æ–‡è„ˆã‚«ãƒ¼ãƒ‰ä½œæˆ</strong>: ä¸»å¼µã¨è¨¼æ‹ ã‚’é–¢é€£ä»˜ã‘</li>
        <li><strong>å‚è€ƒæ–‡çŒ®å‡ºåŠ›</strong>: APA/IEEEå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</li>
    </ol>
</div>
{% endblock %}

{% block scripts %}
<script>
async function handleImport(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const resultDiv = document.getElementById('import-result');
    
    resultDiv.innerHTML = '<p class="alert alert-info">ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...</p>';
    
    try {
        const response = await fetch('/works/import', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    âœ… ${result.imported}ä»¶ã®æ–‡çŒ®ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚
                    ${result.duplicates > 0 ? `(${result.duplicates}ä»¶ã®é‡è¤‡ã‚’é™¤å¤–)` : ''}
                </div>
            `;
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            form.reset();
            
            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆæ–°ã—ã„æ–‡çŒ®ã‚’è¡¨ç¤ºï¼‰
            setTimeout(() => location.reload(), 1500);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">âŒ ã‚¨ãƒ©ãƒ¼: ${result.detail}</div>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
    }
    
    return false;
}
</script>
{% endblock %}

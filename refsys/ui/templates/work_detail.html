{% extends "base.html" %}

{% block title %}{{ work.title }} - RefSys{% endblock %}

{% block content %}
<div class="card">
    <a href="/works" class="btn btn-secondary">â† æ–‡çŒ®ãƒªã‚¹ãƒˆã«æˆ»ã‚‹</a>
</div>

<div class="card">
    <h2>{{ work.title }}</h2>
    
    <p><strong>ã‚¿ã‚¤ãƒ—:</strong> {{ work.type }}</p>
    
    {% if work.authors %}
    <p><strong>è‘—è€…:</strong> 
        {% for author in work.authors %}
        {{ author.given }} {{ author.family }}{% if not loop.last %}, {% endif %}
        {% endfor %}
    </p>
    {% endif %}
    
    {% if work.issued_year %}
    <p><strong>ç™ºè¡Œå¹´:</strong> {{ work.issued_year }}</p>
    {% endif %}
    
    {% if work.container_title %}
    <p><strong>æ²è¼‰èªŒ:</strong> {{ work.container_title }}</p>
    {% endif %}
    
    {% if work.doi %}
    <p><strong>DOI:</strong> <a href="https://doi.org/{{ work.doi }}" target="_blank">{{ work.doi }}</a></p>
    {% endif %}
    
    {% if work.url %}
    <p><strong>URL:</strong> <a href="{{ work.url }}" target="_blank">{{ work.url }}</a></p>
    {% endif %}
    
    <div style="margin-top: 20px;">
        {% if work.peer_reviewed == 1 %}
        <span class="badge badge-peer-reviewed">âœ“ æŸ»èª­ã‚ã‚Š</span>
        {% elif work.peer_reviewed == 0 %}
        <span class="badge badge-not-peer-reviewed">æŸ»èª­ãªã—</span>
        {% endif %}
        
        {% if work.retracted %}
        <span class="badge badge-retracted">âš  æ’¤å›æ¸ˆã¿</span>
        {% endif %}
        
        {% if work.consensus_score %}
        <span class="badge" style="background: #3498db; color: white;">
            åˆæ„åº¦: {{ work.consensus_score }}/100
        </span>
        {% endif %}
    </div>
    
    <div style="margin-top: 20px;">
        <button onclick="verifyWork('{{ work.id }}')" class="btn">ğŸ” å®Ÿåœ¨æ€§æ¤œè¨¼ã‚’å®Ÿè¡Œ</button>
        <button onclick="getCitation('{{ work.id }}')" class="btn btn-secondary">ğŸ“ æœ¬æ–‡ä¸­å¼•ç”¨ã‚’å–å¾—</button>
    </div>
    
    <div id="verification-result" style="margin-top: 15px;"></div>
    <div id="citation-result" style="margin-top: 15px;"></div>
</div>

{% if checks %}
<div class="card">
    <h2>âœ… å®Ÿåœ¨æ€§æ¤œè¨¼çµæœ</h2>
    <table>
        <thead>
            <tr>
                <th>ç¨®é¡</th>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th>è©³ç´°</th>
                <th>HTTPã‚³ãƒ¼ãƒ‰</th>
                <th>ç¢ºèªæ—¥æ™‚</th>
            </tr>
        </thead>
        <tbody>
            {% for check in checks %}
            <tr>
                <td>{{ check.kind }}</td>
                <td class="status-{{ check.status }}">{{ check.status }}</td>
                <td>{{ check.detail }}</td>
                <td>{{ check.http_code or '-' }}</td>
                <td>{{ check.checked_at }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if reading_score %}
<div class="card">
    <h2>ğŸ“– æ—¢èª­è¨¼è·¡ã‚¹ã‚³ã‚¢</h2>
    <div style="font-size: 48px; font-weight: bold; color: {% if reading_score.passed %}#27ae60{% else %}#f39c12{% endif %};">
        {{ reading_score.score }}/100
    </div>
    <p><strong>{{ 'âœ… PASS' if reading_score.passed else 'âš ï¸ è¦è¿½åŠ ä½œæ¥­' }}</strong></p>
    <pre style="white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 5px;">{{ reading_score.details }}</pre>
</div>
{% endif %}

<div class="card">
    <h2>ğŸ’¡ å¼•ç”¨æ–‡è„ˆã‚«ãƒ¼ãƒ‰</h2>
    
    {% if cards %}
    {% for card in cards %}
    <div style="border-left: 4px solid #3498db; padding-left: 15px; margin-bottom: 20px;">
        <p><strong>ä¸»å¼µ:</strong> {{ card.claim }}</p>
        <p><strong>è¨¼æ‹ :</strong> {{ card.evidence_snippet }}</p>
        <p><strong>ãƒšãƒ¼ã‚¸:</strong> {{ card.page_from }}{% if card.page_to != card.page_from %}-{{ card.page_to }}{% endif %}</p>
        {% if card.limitations %}
        <p><strong>é™ç•Œ:</strong> {{ card.limitations }}</p>
        {% endif %}
        <p>
            {% if card.verified %}
            <span class="badge badge-peer-reviewed">âœ“ æ¤œè¨¼æ¸ˆã¿</span>
            {% else %}
            <span class="badge badge-not-peer-reviewed">æœªæ¤œè¨¼</span>
            {% endif %}
        </p>
    </div>
    {% endfor %}
    {% else %}
    <p class="alert alert-info">ã¾ã ã‚«ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
    {% endif %}
    
    <h3>æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ</h3>
    <form action="/works/{{ work.id }}/cards" method="post" onsubmit="return handleCardCreate(event)">
        <label for="claim">ä¸»å¼µï¼ˆã‚ãªãŸãŒä½¿ã†è¦ç‚¹ï¼‰:</label>
        <textarea name="claim" id="claim" required></textarea>
        
        <label for="evidence_snippet">è¨¼æ‹ ï¼ˆæœ¬æ–‡ã‹ã‚‰ã®å¼•ç”¨ã€30-120æ–‡å­—ï¼‰:</label>
        <textarea name="evidence_snippet" id="evidence_snippet" required></textarea>
        
        <label for="page_from">ãƒšãƒ¼ã‚¸ï¼ˆé–‹å§‹ï¼‰:</label>
        <input type="number" name="page_from" id="page_from" required>
        
        <label for="page_to">ãƒšãƒ¼ã‚¸ï¼ˆçµ‚äº†ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰:</label>
        <input type="number" name="page_to" id="page_to">
        
        <label for="limitations">é™ç•Œãƒ»æ³¨æ„ç‚¹:</label>
        <textarea name="limitations" id="limitations"></textarea>
        
        <button type="submit" class="btn">ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ</button>
    </form>
    
    <div id="card-result" style="margin-top: 15px;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function verifyWork(workId) {
    const resultDiv = document.getElementById('verification-result');
    resultDiv.innerHTML = '<p class="alert alert-info">æ¤œè¨¼ä¸­...</p>';
    
    try {
        const response = await fetch(`/works/${workId}/verify`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            let html = '<div class="alert alert-success">âœ… æ¤œè¨¼å®Œäº†</div>';
            html += '<ul>';
            for (const [kind, data] of Object.entries(result.results)) {
                html += `<li><strong>${kind}:</strong> ${data.status} - ${data.detail}</li>`;
            }
            html += '</ul>';
            resultDiv.innerHTML = html;
            
            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
            setTimeout(() => location.reload(), 2000);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">âŒ ã‚¨ãƒ©ãƒ¼: ${result.detail}</div>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
    }
}

async function getCitation(workId) {
    const style = prompt('å¼•ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é¸æŠ (apa/ieee):', 'apa');
    if (!style) return;
    
    const resultDiv = document.getElementById('citation-result');
    
    try {
        const response = await fetch(`/api/works/${workId}/cite?style=${style}`);
        const result = await response.json();
        
        if (response.ok) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong>æœ¬æ–‡ä¸­å¼•ç”¨ (${result.style}):</strong><br>
                    <code style="background: #f8f9fa; padding: 5px 10px; border-radius: 3px; display: inline-block; margin-top: 5px;">${result.citation}</code>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">âŒ ã‚¨ãƒ©ãƒ¼</div>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
    }
}

async function handleCardCreate(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const resultDiv = document.getElementById('card-result');
    
    resultDiv.innerHTML = '<p class="alert alert-info">ä½œæˆä¸­...</p>';
    
    try {
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    âœ… ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã—ãŸã€‚
                    ${result.is_complete ? '(å®Œæˆ)' : '(æœªå®Œæˆ: è¿½åŠ æƒ…å ±ãŒå¿…è¦)'}
                </div>
            `;
            
            form.reset();
            setTimeout(() => location.reload(), 1500);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">âŒ ã‚¨ãƒ©ãƒ¼</div>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
    }
    
    return false;
}
</script>
{% endblock %}
